name: Build Fixed Meshio Exe

on:
  workflow_dispatch: # 允许手动触发
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1. 检出代码
    - uses: actions/checkout@v4

    # 2. 设置 Python 环境 (推荐 3.10 或 3.11，比较稳定)
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 3. 安装依赖
    # 注意：安装 wheel 确保编译环境正常
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install "meshio[all]" pyinstaller

    # 4. 创建入口脚本
    # 使用 bash shell 方便写多行文件
    - name: Create Entry Script
      shell: bash
      run: |
        echo "import sys" > run_meshio.py
        echo "from meshio._main import main" >> run_meshio.py
        echo "if __name__ == '__main__':" >> run_meshio.py
        echo "    sys.exit(main())" >> run_meshio.py

    # 5. 执行打包 (关键步骤)
    # --collect-all meshio: 强制收集 meshio 的所有文件，解决 ModuleNotFoundError
    # --collect-all h5py: 强制收集 h5py，防止处理 .msh/.h5 文件时报错
    # --clean: 清理缓存
    - name: Build with PyInstaller
      run: |
        pyinstaller --clean --noconfirm --onefile --name meshio-cli --collect-all meshio --collect-all h5py run_meshio.py

    # 6. 在 CI 中直接测试 (验证)
    # 这一步是为了确保生成的 exe 能运行。如果报错，Workflow 会直接变红，不用下载后才发现。
    - name: Verify Executable
      run: |
        ./dist/meshio-cli.exe --help
        ./dist/meshio-cli.exe --version

    # 7. 上传构建产物
    - name: Upload Exe Artifact
      uses: actions/upload-artifact@v4
      with:
        name: meshio-windows-exe-fixed
        path: dist/meshio-cli.exe