name: Build Robust Meshio Exe

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      # 显式安装 rich 和 importlib-metadata，防止潜在的 import 错误
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install "meshio[all]" pyinstaller rich

    - name: Create Entry Script
      shell: bash
      # 我们稍微修改一下 Python 脚本，增加一些调试打印，并强制引用 meshio
      run: |
        cat <<EOF > run_meshio.py
        import sys
        import meshio
        # 尝试显式导入私有模块，确保 Python 解释器知道它被使用了
        try:
            from meshio._main import main
        except ImportError as e:
            print("CRITICAL ERROR: Could not import meshio._main")
            print(e)
            sys.exit(1)

        if __name__ == '__main__':
            print(f"Meshio version: {meshio.__version__}")
            sys.exit(main())
        EOF

    - name: Build with PyInstaller
      # 关键修改：
      # 1. --hidden-import=meshio._main : 强制打包 _main 模块
      # 2. --copy-metadata=meshio : 复制元数据（解决版本号读取报错）
      # 3. --collect-all meshio : 暴力收集所有相关文件
      run: |
        pyinstaller --clean --noconfirm --onefile --name meshio-cli \
          --hidden-import=meshio._main \
          --hidden-import=meshio \
          --copy-metadata=meshio \
          --collect-all meshio \
          --collect-all h5py \
          run_meshio.py

    - name: Verify Executable
      run: |
        Write-Output "Testing built executable..."
        ./dist/meshio-cli.exe --help
        ./dist/meshio-cli.exe --version

    - name: Upload Exe Artifact
      uses: actions/upload-artifact@v4
      with:
        name: meshio-windows-exe-final
        path: dist/meshio-cli.exe