name: Build Final Meshio Exe

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install "meshio[all]" pyinstaller rich

    - name: Create Entry Script
      shell: bash
      run: |
        cat <<EOF > run_meshio.py
        import sys
        import meshio
        try:
            from meshio._main import main
        except ImportError as e:
            print("Error importing meshio._main:", e)
            sys.exit(1)

        if __name__ == '__main__':
            sys.exit(main())
        EOF

    # === 关键修正 ===
    # 添加 shell: bash 以支持 '\' 换行符
    - name: Build with PyInstaller
      shell: bash 
      run: |
        pyinstaller --clean --noconfirm --onefile --name meshio-cli \
          --hidden-import=meshio._main \
          --hidden-import=meshio \
          --copy-metadata=meshio \
          --collect-all meshio \
          --collect-all h5py \
          run_meshio.py

    - name: Verify Executable
      shell: bash
      run: |
        echo "Testing executable..."
        ./dist/meshio-cli.exe --help
        ./dist/meshio-cli.exe --version

    - name: Upload Exe Artifact
      uses: actions/upload-artifact@v4
      with:
        name: meshio-windows-exe
        path: dist/meshio-cli.exe