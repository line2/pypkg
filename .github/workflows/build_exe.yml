name: Build Smart Meshio Exe

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        # 安装 meshio[all] 及其依赖
        pip install "meshio[all]" pyinstaller

    # === 核心修改：智能生成入口脚本 ===
    # 不再去猜 "from meshio._main import main"
    # 而是让 Python 告诉我们正确的 import 路径是什么
    - name: Generate Entry Script Dynamically
      shell: bash
      run: |
        python -c "
        import sys
        from importlib.metadata import entry_points

        # 查找名为 'meshio' 的控制台命令
        # 兼容性写法：获取所有 console_scripts 并过滤
        eps = entry_points(group='console_scripts')
        target_ep = next((e for e in eps if e.name == 'meshio'), None)

        if not target_ep:
            print('CRITICAL: Could not find meshio console script!')
            sys.exit(1)

        # 解析入口点字符串 (例如 'meshio._main:main')
        # ep.value 通常是 'module:function' 格式
        mod_name, func_name = target_ep.value.split(':')
        
        print(f'Detected Entry Point: Module=[{mod_name}], Function=[{func_name}]')

        # 生成 Python 脚本
        code = f'''
        import sys
        # 显式导入检测到的模块，让 PyInstaller 能自动识别
        from {mod_name} import {func_name}

        if __name__ == \"__main__\":
            sys.exit({func_name}())
        '''
        
        with open('run_meshio.py', 'w', encoding='utf-8') as f:
            f.write(code)
        "
        
        # 打印出来看看生成的脚本长什么样 (调试用)
        cat run_meshio.py

    - name: Build with PyInstaller
      shell: bash
      run: |
        # --collect-all meshio: 依然保留，因为 meshio 需要加载各种格式插件
        # --copy-metadata: 解决版本号报错
        # 我们不需要手动指定 hidden-import meshio._main 了，因为 run_meshio.py 里已经显式 import 了
        pyinstaller --clean --noconfirm --onefile --name meshio-cli \
          --collect-all meshio \
          --collect-all h5py \
          --copy-metadata=meshio \
          run_meshio.py

    - name: Verify Executable
      shell: bash
      run: |
        echo "Testing built executable..."
        ./dist/meshio-cli.exe --help
        ./dist/meshio-cli.exe --version

    - name: Upload Exe Artifact
      uses: actions/upload-artifact@v4
      with:
        name: meshio-windows-exe-smart
        path: dist/meshio-cli.exe