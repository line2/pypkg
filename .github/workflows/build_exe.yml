name: Auto Sync Smart Meshio Exe

on:
  workflow_dispatch:
  schedule:
    # 每周一 UTC 02:00 (北京时间 10:00) 自动检查
    - cron: '0 2 * * 1'

permissions:
  contents: write

jobs:
  check-and-build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # 获取所有历史记录以便检查 tags

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        # 安装最新版 meshio
        pip install "meshio[all]" pyinstaller

    # === 关键步骤：检查是否需要更新 ===
    - name: Check Version and Existance
      id: check
      shell: bash
      run: |
        # 1. 获取当前安装的 meshio 版本
        VERSION=$(python -c "import meshio; print(meshio.__version__)")
        echo "Detected PyPI Meshio version: $VERSION"
        
        TAG_NAME="v$VERSION"
        echo "MESHIO_VER=$VERSION" >> $GITHUB_ENV
        echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
        
        # 2. 检查这个 Tag 是否在远程仓库已存在
        # git ls-remote返回非空说明已存在
        if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          echo "Tag $TAG_NAME already exists. Skipping build."
          echo "SKIP_BUILD=true" >> $GITHUB_ENV
        else
          echo "New version detected ($TAG_NAME). Proceeding with build."
          echo "SKIP_BUILD=false" >> $GITHUB_ENV
        fi

    # === 下面的步骤全部加上 if 条件 ===
    
    - name: Generate Entry Script Dynamically
      if: env.SKIP_BUILD == 'false'
      shell: bash
      run: |
        python -c "
        import sys
        from importlib.metadata import entry_points
        eps = entry_points(group='console_scripts')
        target_ep = next((e for e in eps if e.name == 'meshio'), None)
        if not target_ep: sys.exit(1)
        mod_name, func_name = target_ep.value.split(':')
        code = f'''
        import sys
        from {mod_name} import {func_name}
        if __name__ == \"__main__\":
            sys.exit({func_name}())
        '''
        with open('run_meshio.py', 'w', encoding='utf-8') as f:
            f.write(code)
        "

    - name: Build with PyInstaller
      if: env.SKIP_BUILD == 'false'
      shell: bash
      run: |
        pyinstaller --clean --noconfirm --onefile \
          --name "meshio-cli-${{ env.MESHIO_VER }}" \
          --collect-all meshio \
          --collect-all h5py \
          --copy-metadata=meshio \
          run_meshio.py

    - name: Verify Executable
      if: env.SKIP_BUILD == 'false'
      shell: bash
      run: |
        ./dist/meshio-cli-${{ env.MESHIO_VER }}.exe --version

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: env.SKIP_BUILD == 'false'
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: Meshio CLI ${{ env.TAG_NAME }}
        body: |
          Automatic weekly sync build.
          Upstream Meshio Version: ${{ env.MESHIO_VER }}
        draft: false
        prerelease: false
        files: |
          dist/meshio-cli-${{ env.MESHIO_VER }}.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}